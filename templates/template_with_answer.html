{% extends 'base.html' %}
{% load static %}
{% block title %}Введение данных{% endblock title %}
{% block content %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <div class="row"> <!-- Bootstrap: Создание списка файлов -->
        <div class="col-md-12">
            <h2>Список файлов</h2>
            {% if filters %}
                <label for="filters"></label>
                <select id="filters" class="form-select" data-public="{{ public_key }}" name="filter">
                    {% for key, value in filters.items %}
                        <option value="{{ value }}">{{ key }}</option>
                    {% endfor %}
                </select>
            {% endif %}
            <div class="list-group" id="main-list">
                {% if path %}
                    <a href="{% url 'yandex_disk_api' %}?public_key={{ public_key }}&path={{ old_path }}" class="btn btn-secondary my-2">
                        Назад{{ path }}
                    </a>
                {% endif %}
                {% for field in answer %}
                    <div class="list-group-item d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            {% if field.type == "file" %}
                                <img src="{{ field.link }}"
                                     alt="Файл"
                                     class="me-3 img-thumbnail"
                                     style="width: 50px; height: 50px;"
                                     onerror="this.src='{% static 'file.jpg' %}'">
                            {% else %}
                                <img src="{% static "dir.png" %}"
                                     alt="Файл" class="me-3 img-thumbnail"
                                     style="width: 50px; height: 50px;">
                            {% endif %}
                            <span>{{ field.name }}</span>
                        </div>
                        <div>
                            <button class="btn btn-primary fetchButton" data-link="{{ field.download_link }}">Скачать файл</button>
                            {% if field.type == "dir" %}
                                <a href="{% url 'yandex_disk_api' %}?public_key={{ public_key }}&path={{ field.path }}&filter={{ filter }}" class="btn btn-info">
                                    Перейти
                                </a>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        document.querySelectorAll("[data-link]").forEach(button => {
                button.onclick = async function (event) {
                    let button = event.target;
                    let link = button.dataset.link;
                    let response = await fetch(`/get_link/${link}`);
                    const data = await response.json();
                    if (data.href) {
                        let a = document.createElement("a");
                        a.href = data.href;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    }
                }
            }
        )
        document.getElementById("filters").addEventListener("change", function () {
            const params = new URLSearchParams(window.location.search)
            params.set("public_key", this.dataset.public)
            params.delete("filter")
            params.set("filter", this.value)
            window.location.href = window.location.origin + "/yandex_disk_api/?" + params.toString();
        });
        document.getElementById("filters").value = "{{filter}}";
    </script>

{% endblock content %}
